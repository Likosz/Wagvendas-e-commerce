<!-- Skeleton Loader -->
@if (loading) {
  <div class="product-card-skeleton" role="status" aria-label="Carregando produto">
    <div class="skeleton-image"></div>
    <div class="skeleton-content">
      <div class="skeleton-line skeleton-title"></div>
      <div class="skeleton-line skeleton-price"></div>
      <div class="skeleton-line skeleton-rating"></div>
      <div class="skeleton-button"></div>
    </div>
    <span class="sr-only">Carregando...</span>
  </div>
}

<!-- Product Card -->
@if (!loading && product) {
  <article
    class="product-card group relative bg-white dark:bg-dark-900 rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden"
    [attr.aria-label]="product!.name"
  >
    <!-- Product Link Wrapper -->
    <a
      [routerLink]="['/produto', product.slug]"
      class="block focus:outline-none focus-visible:ring-4 focus-visible:ring-primary-500/50 rounded-xl"
      [attr.aria-label]="'Ver detalhes de ' + product.name"
    >
      <!-- Image Container -->
      <div class="relative aspect-square overflow-hidden bg-dark-50 dark:bg-dark-800">
        <!-- Main Image -->
        <img
          [src]="product.thumbnail"
          [alt]="product.name"
          loading="lazy"
          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
        />

        <!-- Badges Container (Top) -->
        <div class="absolute top-3 left-3 right-3 flex flex-wrap gap-2 z-10">
          @if (product.discount && product.discount > 0) {
            <span
              class="inline-flex items-center gap-1 px-2.5 py-1 bg-transparent text-amber-400 border border-amber-400 dark:text-amber-300 dark:border-amber-300 text-xs font-bold rounded-full shadow-lg"
              aria-label="Desconto de {{ getDiscountPercentage() }} por cento"
            >
              <lucide-icon [img]="icons.TrendingUp" [size]="14"></lucide-icon>
              -{{ getDiscountPercentage() }}%
            </span>
          }

          @if (product.isNew) {
            <span
              class="px-2.5 py-1 bg-transparent text-primary-300 border border-primary-300 text-xs font-bold rounded-full shadow-lg"
              aria-label="Produto novo"
            >
              NOVO
            </span>
          }

          @if (product.freeShipping) {
            <span
              class="inline-flex items-center gap-1 px-2.5 py-1 bg-transparent text-accent-300 border border-accent-300 text-xs font-bold rounded-full shadow-lg"
              aria-label="Frete grátis"
            >
              <lucide-icon [img]="icons.Truck" [size]="14"></lucide-icon>
              FRETE GRÁTIS
            </span>
          }
        </div>

        <!-- Hover Overlay with Actions -->
        <div
          class="absolute inset-0 bg-gradient-to-t from-dark-900/80 via-dark-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end justify-center pb-6"
        >
          <button
            type="button"
            (click)="onQuickView($event)"
            class="px-6 py-2.5 bg-white dark:bg-dark-800 text-dark-900 dark:text-white rounded-full font-medium shadow-lg hover:bg-dark-50 dark:hover:bg-dark-700 transition-all duration-200 transform translate-y-4 group-hover:translate-y-0 flex items-center gap-2"
            aria-label="Visualização rápida de {{ product.name }}"
          >
            <lucide-icon [img]="icons.Eye" [size]="18"></lucide-icon>
            <span>Visualização Rápida</span>
          </button>
        </div>

        <!-- Wishlist Button (Top Right) -->
        <button
          type="button"
          (click)="onToggleWishlist($event)"
          class="absolute top-3 right-3 z-20 p-2.5 bg-white/90 dark:bg-dark-900/90 backdrop-blur-sm rounded-full shadow-lg hover:bg-white dark:hover:bg-dark-800 transition-all duration-200 hover:scale-110 focus:outline-none focus-visible:ring-4 focus-visible:ring-primary-500/50"
          [class.text-error-500]="isInWishlist()"
          [class.text-dark-400]="!isInWishlist()"
          [attr.aria-label]="
            isInWishlist()
              ? 'Remover ' + product.name + ' da lista de desejos'
              : 'Adicionar ' + product.name + ' à lista de desejos'
          "
          [attr.aria-pressed]="isInWishlist()"
        >
          <lucide-icon [img]="icons.Heart" [size]="20"></lucide-icon>
        </button>

        <!-- Stock Badge (Bottom Right) -->
        @if (!product.inStock) {
          <span
            class="absolute bottom-3 right-3 px-3 py-1.5 bg-dark-900/90 text-white text-xs font-semibold rounded-lg"
            aria-label="Produto esgotado"
          >
            ESGOTADO
          </span>
        } @else if (product.lowStock) {
          <span
            class="absolute bottom-3 right-3 px-3 py-1.5 bg-warning-500/90 text-white text-xs font-semibold rounded-lg"
            aria-label="Últimas unidades"
          >
            ÚLTIMAS UNIDADES
          </span>
        }
      </div>

      <!-- Card Content -->
      <div class="p-4 space-y-3">
        <!-- Brand -->
        <p
          class="text-xs font-medium text-primary-600 dark:text-primary-400 uppercase tracking-wide"
        >
          {{ product.brand }}
        </p>

        <!-- Product Name -->
        <h3
          class="text-base font-semibold text-dark-900 dark:text-white line-clamp-2 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors duration-200"
        >
          {{ product.name }}
        </h3>

        <!-- Short Description -->
        @if (product.shortDescription) {
          <p class="text-sm text-dark-600 dark:text-dark-400 line-clamp-2">
            {{ product.shortDescription }}
          </p>
        }

        <!-- Rating -->
        <div class="flex items-center gap-2">
          <div
            class="flex items-center gap-0.5"
            role="img"
            [attr.aria-label]="'Avaliação: ' + product.rating + ' de 5 estrelas'"
          >
            @for (star of getStarArray(); track star) {
              @if (getStarType(star) === 'full') {
                <lucide-icon
                  [img]="icons.Star"
                  [size]="16"
                  class="text-warning-500 star-active"
                  aria-hidden="true"
                ></lucide-icon>
              } @else if (getStarType(star) === 'half') {
                <div class="relative" aria-hidden="true">
                  <lucide-icon
                    [img]="icons.Star"
                    [size]="16"
                    class="text-dark-300 dark:text-dark-600"
                  ></lucide-icon>
                  <lucide-icon
                    [img]="icons.Star"
                    [size]="16"
                    class="text-warning-500 absolute top-0 left-0 overflow-hidden star-active"
                    style="clip-path: inset(0 50% 0 0)"
                  ></lucide-icon>
                </div>
              } @else {
                <lucide-icon
                  [img]="icons.Star"
                  [size]="16"
                  class="text-dark-300 dark:text-dark-600"
                  aria-hidden="true"
                ></lucide-icon>
              }
            }
          </div>

          <span
            class="text-sm text-dark-600 dark:text-dark-400"
            aria-label="{{ product.reviewCount }} avaliações"
          >
            ({{ product.reviewCount }})
          </span>
        </div>

        <!-- Price -->
        <div class="space-y-1">
          @if (product.originalPrice && product.originalPrice > product.price) {
            <p
              class="text-sm text-dark-500 dark:text-dark-500 line-through"
              aria-label="Preço original"
            >
              {{ formatPrice(product.originalPrice) }}
            </p>
          }

          <div class="flex items-baseline gap-2">
            <p
              class="text-2xl font-bold text-dark-900 dark:text-white"
              aria-label="Preço atual: {{ formatPrice(product.price) }}"
            >
              {{ formatPrice(product.price) }}
            </p>

            @if (product.discount && product.discount > 0) {
              <span
                class="text-sm font-medium text-success-600 dark:text-success-400"
                aria-label="Economia"
              >
                Economize {{ getDiscountPercentage() }}%
              </span>
            }
          </div>
        </div>
      </div>
    </a>

    <!-- Add to Cart Button -->
    <div class="px-4 pb-4">
      <button
        type="button"
        (click)="onAddToCart($event)"
        [disabled]="!product.inStock || isAddingToCart()"
        class="w-full py-3 bg-primary-600 hover:bg-primary-700 disabled:bg-dark-300 dark:disabled:bg-dark-700 text-white font-semibold rounded-lg transition-all duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-60 focus:outline-none focus-visible:ring-4 focus-visible:ring-primary-500/50"
        [attr.aria-label]="
          !product.inStock
            ? 'Produto esgotado'
            : isAddingToCart()
              ? 'Adicionando ao carrinho'
              : 'Adicionar ' + product.name + ' ao carrinho'
        "
      >
        @if (isAddingToCart()) {
          <svg
            class="animate-spin h-5 w-5"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <span>Adicionando...</span>
        } @else if (!product.inStock) {
          <span>Esgotado</span>
        } @else {
          <lucide-icon [img]="icons.ShoppingCart" [size]="20" aria-hidden="true"></lucide-icon>
          <span>Adicionar ao Carrinho</span>
        }
      </button>
    </div>
  </article>
}
