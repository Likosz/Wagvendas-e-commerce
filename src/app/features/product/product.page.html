<!-- Loading State -->
@if (loading()) {
  <div class="min-h-screen flex items-center justify-center">
    <div class="text-center space-y-4">
      <div class="animate-spin rounded-full h-16 w-16 border-4 border-primary-600 border-t-transparent mx-auto"></div>
      <p class="text-dark-600 dark:text-dark-400">Carregando produto...</p>
    </div>
  </div>
}

<!-- Not Found State -->
@if (notFound() && !loading()) {
  <div class="min-h-screen flex items-center justify-center">
    <div class="text-center space-y-6 px-4">
      <h1 class="text-4xl font-bold text-dark-900 dark:text-white">Produto não encontrado</h1>
      <p class="text-dark-600 dark:text-dark-400">
        O produto que você está procurando não existe ou foi removido.
      </p>
      <a
        routerLink="/"
        class="inline-block px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition-colors"
      >
        Voltar para Home
      </a>
    </div>
  </div>
}

<!-- Product Content -->
@if (product() && !loading()) {
  <div class="bg-dark-50 dark:bg-dark-950">
    <div class="container-custom py-8">
      <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-sm">
          @for (crumb of breadcrumbs(); track $index; let isLast = $last) {
            <li class="flex items-center gap-2">
              @if (!isLast && crumb.url) {
                <a
                  [routerLink]="crumb.url"
                  [queryParams]="crumb.query"
                  class="text-dark-600 dark:text-dark-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
                >
                  {{ crumb.label }}
                </a>
                <span class="text-dark-400 dark:text-dark-600">/</span>
              } @else {
                <span class="text-dark-900 dark:text-white font-medium">{{ crumb.label }}</span>
              }
            </li>
          }
        </ol>
      </nav>

      <!-- Product Main Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 mb-16">
        <div class="space-y-4">
          <!-- Imagem Principal -->
          <div
            class="relative aspect-square bg-white dark:bg-dark-900 rounded-xl overflow-hidden shadow-lg group cursor-zoom-in"
            (click)="toggleZoom()"
          >
            <img
              [src]="selectedImage()"
              [alt]="prod().name"
              class="w-full h-full object-cover transition-transform duration-300"
              [class.scale-150]="isImageZoomed()"
            />

            <!-- Badges -->
            <div class="absolute top-4 left-4 right-4 flex flex-wrap gap-2 z-10">
              @if (prod().discount! && prod().discount! > 0) {
                <span class="px-3 py-1 bg-error-500 text-white text-sm font-bold rounded-full shadow-lg">
                  -{{ prod().discount }}%
                </span>
              }
              @if (prod().isNew) {
                <span class="px-3 py-1 bg-success-500 text-white text-sm font-bold rounded-full shadow-lg">
                  NOVO
                </span>
              }
              @if (prod().freeShipping) {
                <span class="px-3 py-1 bg-accent-500 text-white text-sm font-bold rounded-full shadow-lg">
                  FRETE GRÁTIS
                </span>
              }
            </div>
          </div>

          <!-- Thumbnails -->
          @if (prod().images.length > 1) {
            <div class="grid grid-cols-5 gap-2">
              @for (image of prod().images; track $index) {
                <button
                  type="button"
                  (click)="selectImage($index)"
                  class="aspect-square rounded-lg overflow-hidden border-2 transition-all"
                  [class.border-primary-600]="selectedImageIndex() === $index"
                  [class.border-dark-200]="selectedImageIndex() !== $index"
                  [class.dark:border-primary-600]="selectedImageIndex() === $index"
                  [class.dark:border-dark-700]="selectedImageIndex() !== $index"
                  [attr.aria-label]="'Ver imagem ' + ($index + 1)"
                >
                  <img [src]="image" [alt]="prod().name + ' - Imagem ' + ($index + 1)" class="w-full h-full object-cover" />
                </button>
              }
            </div>
          }
        </div>

        <!-- Informações do Produto -->
        <div class="space-y-6">
          <!-- Título e Marca -->
          <div>
            <p class="text-sm font-medium text-primary-600 dark:text-primary-400 uppercase tracking-wide mb-2">
              {{ prod().brand }}
            </p>
            <h1 class="text-3xl md:text-4xl font-bold text-dark-900 dark:text-white mb-3">
              {{ prod().name }}
            </h1>

            <!-- Avaliação estrelas-->
            <div class="flex items-center gap-3">
              <div
                class="flex items-center gap-1"
                role="radiogroup"
                aria-label="Avaliar este produto"
                (mouseleave)="onStarLeave()"
              >
                @for (star of starArray; track star) {
                  <button
                    type="button"
                    class="p-1 rounded-md focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500/50"
                    role="radio"
                    [attr.aria-checked]="isUserStarActive(star)"
                    [attr.aria-label]="'Avaliar com ' + star + ' estrelas'"
                    (mouseenter)="onStarEnter(star)"
                    (focus)="onStarEnter(star)"
                    (blur)="onStarLeave()"
                    (click)="onStarSelect(star)"
                    (keydown)="onStarKeydown($event, star)"
                  >
                    <span class="relative inline-block align-middle" aria-hidden="true">
                      <lucide-icon
                        [img]="icons.Star"
                        [size]="18"
                        class="absolute inset-0 pointer-events-none star-fill"
                        [class.text-primary-500]="isUserStarActive(star)"
                        [class.text-transparent]="!isUserStarActive(star)"
                      ></lucide-icon>

                      <lucide-icon
                        [img]="icons.Star"
                        [size]="18"
                        [class.text-primary-500]="isUserStarActive(star)"
                        [class.text-dark-300]="!isUserStarActive(star)"
                        [class.dark:text-dark-600]="!isUserStarActive(star)"
                        [class.star-active]="isUserStarActive(star)"
                      ></lucide-icon>
                    </span>
                  </button>
                }
              </div>
              <span class="text-sm text-dark-600 dark:text-dark-400">
                {{ prod().rating }} ({{ prod().reviewCount }} avaliações)
                @if (userRating() > 0) { · Sua avaliação: {{ userRating() }}/5 }
              </span>
            </div>
          </div>

          <!-- Preço -->
          <div class="py-4 border-y border-dark-200 dark:border-dark-700">
            @if (prod().originalPrice! && prod().originalPrice! > finalPrice()) {
              <p class="text-lg text-dark-500 dark:text-dark-500 line-through mb-1">
                {{ formatPrice(prod().originalPrice!) }}
              </p>
            }
            <div class="flex items-baseline gap-3">
              <p class="text-4xl font-bold text-dark-900 dark:text-white">
                {{ formatPrice(finalPrice()) }}
              </p>
              @if (prod().discount! && prod().discount! > 0) {
                <span class="text-lg font-medium text-success-600 dark:text-success-400">
                  Economize {{ prod().discount }}%
                </span>
              }
            </div>
            <p class="mt-1 text-sm text-dark-700 dark:text-dark-300" aria-live="polite">
              Total para {{ quantity() }} {{ quantity() === 1 ? 'unidade' : 'unidades' }}:
              <span class="font-semibold text-dark-900 dark:text-white">
                {{ formatPrice(totalPrice()) }}
              </span>
            </p>
          </div>

          <!-- Descrição Curta -->
          @if (prod().shortDescription) {
            <p class="text-base text-dark-700 dark:text-dark-300 leading-relaxed">
              {{ prod().shortDescription }}
            </p>
          }

          <!-- Variantes -->
          @for (type of getVariantTypes(); track type) {
            <div>
              <h3 class="text-sm font-semibold text-dark-900 dark:text-white mb-3">
                {{ translateVariantType(type) }}:
                <span class="text-primary-600 dark:text-primary-400">
                  {{ selectedVariants().get(type) }}
                </span>
              </h3>

              <div class="flex flex-wrap gap-2">
                @for (variant of getVariantsByType(type); track variant.id) {
                  <button
                    type="button"
                    (click)="selectVariant(type, variant.value)"
                    class="px-4 py-2 border-2 rounded-lg font-medium transition-all"
                    [class.border-primary-600]="isVariantSelected(type, variant.value)"
                    [class.bg-primary-50]="isVariantSelected(type, variant.value)"
                    [class.dark:bg-primary-900/20]="isVariantSelected(type, variant.value)"
                    [class.text-primary-600]="isVariantSelected(type, variant.value)"
                    [class.dark:text-primary-400]="isVariantSelected(type, variant.value)"
                    [class.border-dark-200]="!isVariantSelected(type, variant.value)"
                    [class.dark:border-dark-700]="!isVariantSelected(type, variant.value)"
                    [class.hover:border-primary-300]="!isVariantSelected(type, variant.value)"
                    [attr.aria-label]="translateVariantType(type) + ': ' + variant.value"
                  >
                    {{ variant.name }}
                  </button>
                }
              </div>
            </div>
          }

          <!-- Quantidade e Estoque -->
          <div>
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-dark-900 dark:text-white">Quantidade</h3>
              <span
                class="text-sm"
                [class.text-success-600]="availableStock() > 10"
                [class.dark:text-success-400]="availableStock() > 10"
                [class.text-warning-600]="availableStock() > 0 && availableStock() <= 10"
                [class.dark:text-warning-400]="availableStock() > 0 && availableStock() <= 10"
                [class.text-error-600]="availableStock() === 0"
                [class.dark:text-error-400]="availableStock() === 0"
              >
                @if (availableStock() > 10) {
                  Em estoque
                } @else if (availableStock() > 0) {
                  Últimas {{ availableStock() }} unidades
                } @else {
                  Esgotado
                }
              </span>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex items-center border-2 border-dark-200 dark:border-dark-700 rounded-lg overflow-hidden">
                <button
                  type="button"
                  (click)="decreaseQuantity()"
                  [disabled]="quantity() <= 1"
                  class="px-4 py-3 hover:bg-dark-100 dark:hover:bg-dark-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  aria-label="Diminuir quantidade"
                >
                  -
                </button>
                <span class="px-6 py-3 font-semibold text-dark-900 dark:text-white min-w-[60px] text-center">
                  {{ quantity() }}
                </span>
                <button
                  type="button"
                  (click)="increaseQuantity()"
                  [disabled]="quantity() >= availableStock()"
                  class="px-4 py-3 hover:bg-dark-100 dark:hover:bg-dark-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  aria-label="Aumentar quantidade"
                >
                  +
                </button>
              </div>
            </div>
          </div>

          <!-- Botões de Ação -->
          <div class="space-y-3">
            <button
              type="button"
              (click)="addToCart()"
              [disabled]="availableStock() === 0"
              class="w-full py-4 bg-primary-600 hover:bg-primary-700 disabled:bg-dark-300 dark:disabled:bg-dark-700 text-white font-semibold rounded-lg transition-all shadow-lg hover:shadow-xl disabled:cursor-not-allowed disabled:opacity-60"
            >
              @if (availableStock() === 0) {
                Produto Esgotado
              } @else {
                Adicionar ao Carrinho
              }
            </button>

            <button
              type="button"
              (click)="buyNow()"
              [disabled]="availableStock() === 0"
              class="w-full py-4 bg-dark-900 hover:bg-dark-800 dark:bg-dark-100 dark:hover:bg-dark-200 dark:text-dark-900 text-white font-semibold rounded-lg transition-all disabled:cursor-not-allowed disabled:opacity-60"
            >
              Comprar Agora
            </button>

            <div class="flex gap-3">
              <button
                type="button"
                (click)="toggleWishlist()"
                class="flex-1 py-3 px-4 border-2 border-dark-200 dark:border-dark-700 rounded-lg font-medium transition-all flex items-center justify-center gap-2"
                [class.border-error-500]="isInWishlist()"
                [class.bg-error-50]="isInWishlist()"
                [class.dark:bg-error-900/20]="isInWishlist()"
                [class.text-error-600]="isInWishlist()"
                [class.dark:text-error-400]="isInWishlist()"
                [class.hover:bg-dark-50]="!isInWishlist()"
                [class.dark:hover:bg-dark-800]="!isInWishlist()"
                [attr.aria-label]="isInWishlist() ? 'Remover da lista de desejos' : 'Adicionar à lista de desejos'"
              >
                <lucide-icon [img]="icons.Heart" [size]="20"></lucide-icon>
                <span>{{ isInWishlist() ? 'Na Wishlist' : 'Adicionar à Wishlist' }}</span>
              </button>

              <button
                type="button"
                (click)="share()"
                class="py-3 px-4 border-2 border-dark-200 dark:border-dark-700 hover:bg-dark-50 dark:hover:bg-dark-800 rounded-lg transition-all"
                aria-label="Compartilhar produto"
              >
                <lucide-icon [img]="icons.Share2" [size]="20"></lucide-icon>
              </button>
            </div>
          </div>

          <!-- Benefícios -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 border-t border-dark-200 dark:border-dark-700">
            <div class="flex items-start gap-3">
              <lucide-icon [img]="icons.Truck" [size]="24" class="text-primary-600 dark:text-primary-400 flex-shrink-0"></lucide-icon>
              <div>
                <p class="font-semibold text-dark-900 dark:text-white text-sm">Frete Rápido</p>
                <p class="text-xs text-dark-600 dark:text-dark-400">Entrega em todo Brasil</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <lucide-icon [img]="icons.ShieldCheck" [size]="24" class="text-primary-600 dark:text-primary-400 flex-shrink-0"></lucide-icon>
              <div>
                <p class="font-semibold text-dark-900 dark:text-white text-sm">Compra Segura</p>
                <p class="text-xs text-dark-600 dark:text-dark-400">Pagamento protegido</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <lucide-icon [img]="icons.RotateCcw" [size]="24" class="text-primary-600 dark:text-primary-400 flex-shrink-0"></lucide-icon>
              <div>
                <p class="font-semibold text-dark-900 dark:text-white text-sm">Devolução Grátis</p>
                <p class="text-xs text-dark-600 dark:text-dark-400">Até 30 dias</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-white dark:bg-dark-900 rounded-xl shadow-sm overflow-hidden mb-16">
        <div class="border-b border-dark-200 dark:border-dark-700">
          <nav class="flex" aria-label="Tabs">
            <button
              type="button"
              (click)="setActiveTab('description')"
              class="flex-1 px-6 py-4 font-semibold transition-colors border-b-2"
              [class.border-primary-600]="activeTab() === 'description'"
              [class.text-primary-600]="activeTab() === 'description'"
              [class.dark:text-primary-400]="activeTab() === 'description'"
              [class.border-transparent]="activeTab() !== 'description'"
              [class.text-dark-600]="activeTab() !== 'description'"
              [class.dark:text-dark-400]="activeTab() !== 'description'"
              [class.hover:text-dark-900]="activeTab() !== 'description'"
              [class.dark:hover:text-white]="activeTab() !== 'description'"
              [attr.aria-current]="activeTab() === 'description' ? 'page' : undefined"
            >
              Descrição
            </button>

            <button
              type="button"
              (click)="setActiveTab('specs')"
              class="flex-1 px-6 py-4 font-semibold transition-colors border-b-2"
              [class.border-primary-600]="activeTab() === 'specs'"
              [class.text-primary-600]="activeTab() === 'specs'"
              [class.dark:text-primary-400]="activeTab() === 'specs'"
              [class.border-transparent]="activeTab() !== 'specs'"
              [class.text-dark-600]="activeTab() !== 'specs'"
              [class.dark:text-dark-400]="activeTab() !== 'specs'"
              [class.hover:text-dark-900]="activeTab() !== 'specs'"
              [class.dark:hover:text-white]="activeTab() !== 'specs'"
              [attr.aria-current]="activeTab() === 'specs' ? 'page' : undefined"
            >
              Especificações
            </button>

            <button
              type="button"
              (click)="setActiveTab('reviews')"
              class="flex-1 px-6 py-4 font-semibold transition-colors border-b-2"
              [class.border-primary-600]="activeTab() === 'reviews'"
              [class.text-primary-600]="activeTab() === 'reviews'"
              [class.dark:text-primary-400]="activeTab() === 'reviews'"
              [class.border-transparent]="activeTab() !== 'reviews'"
              [class.text-dark-600]="activeTab() !== 'reviews'"
              [class.dark:text-dark-400]="activeTab() !== 'reviews'"
              [class.hover:text-dark-900]="activeTab() !== 'reviews'"
              [class.dark:hover:text-white]="activeTab() !== 'reviews'"
              [attr.aria-current]="activeTab() === 'reviews' ? 'page' : undefined"
            >
              Avaliações ({{ prod().reviewCount }})
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-8">
          @if (activeTab() === 'description') {
            <div class="prose dark:prose-invert max-w-none">
              <p class="text-dark-700 dark:text-dark-300 leading-relaxed whitespace-pre-line">
                {{ prod().description }}
              </p>
            </div>
          }

          <!-- Specs Tab -->
          @if (activeTab() === 'specs') {
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-4 py-3 border-b border-dark-200 dark:border-dark-700">
                <span class="font-semibold text-dark-900 dark:text-white">SKU</span>
                <span class="text-dark-700 dark:text-dark-300">{{ prod().sku }}</span>
              </div>

              <div class="grid grid-cols-2 gap-4 py-3 border-b border-dark-200 dark:border-dark-700">
                <span class="font-semibold text-dark-900 dark:text-white">Marca</span>
                <span class="text-dark-700 dark:text-dark-300">{{ prod().brand }}</span>
              </div>

              <div class="grid grid-cols-2 gap-4 py-3 border-b border-dark-200 dark:border-dark-700">
                <span class="font-semibold text-dark-900 dark:text-white">Categoria</span>
                <span class="text-dark-700 dark:text-dark-300">{{ prod().categoryName }}</span>
              </div>

              @if (prod().weight) {
                <div class="grid grid-cols-2 gap-4 py-3 border-b border-dark-200 dark:border-dark-700">
                  <span class="font-semibold text-dark-900 dark:text-white">Peso</span>
                  <span class="text-dark-700 dark:text-dark-300">{{ prod().weight }}g</span>
                </div>
              }

              @if (prod().dimensions) {
                <div class="grid grid-cols-2 gap-4 py-3 border-b border-dark-200 dark:border-dark-700">
                  <span class="font-semibold text-dark-900 dark:text-white">Dimensões</span>
                  <span class="text-dark-700 dark:text-dark-300">
                    {{ prod().dimensions!.width }} x {{ prod().dimensions!.height }} x {{ prod().dimensions!.depth }} cm
                  </span>
                </div>
              }

              <div class="grid grid-cols-2 gap-4 py-3">
                <span class="font-semibold text-dark-900 dark:text-white">Tags</span>
                <div class="flex flex-wrap gap-2">
                  @for (tag of prod().tags; track tag) {
                    <span class="px-3 py-1 bg-dark-100 dark:bg-dark-800 text-dark-700 dark:text-dark-300 text-sm rounded-full">
                      {{ tag }}
                    </span>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Reviews Tab -->
          @if (activeTab() === 'reviews') {
            <div class="text-center py-12">
              <p class="text-dark-600 dark:text-dark-400">Sistema de avaliações em desenvolvimento.</p>
              <p class="text-sm text-dark-500 dark:text-dark-500 mt-2">Em breve você poderá ver e deixar avaliações!</p>
            </div>
          }
        </div>
      </div>

      <!-- Produtos Relacionados -->
      @if (relatedProducts().length > 0) {
        <div>
          <h2 class="text-2xl md:text-3xl font-bold text-dark-900 dark:text-white mb-6">Produtos Relacionados</h2>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            @for (relatedProduct of relatedProducts(); track relatedProduct.id) {
              <app-product-card
                [product]="relatedProduct"
                [loading]="false"
              ></app-product-card>
            }
          </div>
        </div>
      }
    </div>
  </div>
}
